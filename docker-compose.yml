version: '0.1'

services:

  db-postgresql:
    image: vector_pt_br
    command: postgres -c 'max_connections=400'
    container_name: ${ENV_NAME}_postgres
    user: ${POSTGRES_USER}  
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 3s
      timeout: 5s
      retries: 10
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: rinha
      POSTGRES_HOST_AUTH_METHOD: trust
    logging:
          options:
            max-size: 10m
            max-file: "3"
    ports:
          - '5432:5432'
    volumes:
      - /var/lib/postgresql:/var/lib/postgresql   
      - ps_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: '1.3GB'
    networks:
      - vector-network

  vector1: &vector
    #image: walmeidasantos/herecomesanewchallenger:latest
    build: .
    hostname: vector1
    environment:
        - DATABASE_URL = postgresql://postgres:postgres@rinha?socket=/var/run/postgresql/")
        - ENV_NAME=vector
        - GUNICORN_BIND=0.0.0.0:8000
        - GUNICORN_WORKERS=2
        - GUNICORN_KEEPALIVE=4
        - GUNICORN_FORWARDED_ALLOW_IPS=*
    depends_on:
        db-postgresql:
          condition: service_healthy
    volumes:
      - socks:/tmp
    deploy:
        resources:
          limits:
            cpus: '0.3'
            memory: '0.6GB'
    # ports:
    # - '8000:8000'
    networks:
        - vector-network

  vector2:
    <<: *vector
    hostname: vector2

  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - socks:/tmp
    depends_on:
      vector1:
        condition: service_healthy
      vector2:
        condition: service_healthy
    ulimits:
      nproc: 1000000
      nofile:
        soft: 1000000
        hard: 1000000
    ports:
      - "9999:9999"
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: '0.1GB'
    networks:
      - vector-network

networks:
  vector-network:

volumes:
  ps_data:
    name: ${ENV_NAME}_postgres
  socks: